<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Jewish Music Preview - The ultimate kosher streaming experience with advanced filtering, whitelist/blacklist controls, and high-quality Jewish tracks.">
    <meta name="keywords" content="Jewish Music, Kosher Stream, Jewish Radio, Jewish Songs, Whitelist Music, Filtered Music">
    <meta name="author" content="KosherStream Ultra">
    <meta property="og:title" content="Jewish Music Preview">
    <meta property="og:description" content="Stream your favorite Jewish music with total peace of mind.">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽµ</text></svg>">
    <title>Jewish Music Preview</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --app-scale: 1;
            --accent-color: #3b82f6;
        }
        body {
            background-color: #050505;
            color: #ffffff;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            transition: background-color 0.5s ease;
        }
        body.theater-mode {
            background-color: #000000;
        }
        body.theater-mode aside, 
        body.theater-mode header {
            opacity: 0.1;
            filter: grayscale(1);
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
        body.theater-mode footer {
            border-top-color: #111;
        }
        #app-viewport {
            transform: scale(var(--app-scale));
            transform-origin: top left;
            width: calc(100% / var(--app-scale));
            height: calc(100% / var(--app-scale));
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .glass {
            background: rgba(20, 20, 20, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #222;
            border-radius: 10px;
        }
        .visualizer-bar {
            transition: height 0.08s ease;
            width: 4px;
            background: var(--accent-color);
            margin: 0 1px;
            border-radius: 2px;
            height: 4px;
        }
        input[type="range"] { accent-color: var(--accent-color); cursor: pointer; }
        .song-card { transition: all 0.2s ease; }
        .song-card:hover { transform: translateY(-4px); background: rgba(255,255,255,0.05); }
        .animate-pop { animation: pop 0.3s ease-out; }
        @keyframes pop {
            0% { transform: scale(0.95); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .notification-dot {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            display: none;
        }
    </style>
</head>
<body>

    <!-- Startup Size Picker -->
    <div id="onboarding" class="fixed inset-0 z-[200] bg-black flex items-center justify-center p-6 text-center">
        <div class="max-w-2xl bg-neutral-900 p-10 rounded-3xl border border-neutral-800 shadow-2xl">
            <h1 class="text-5xl font-black mb-4 text-blue-500 italic">JEWISH MUSIC PREVIEW</h1>
            <p class="text-neutral-400 mb-10">Select your optimal display density to begin.</p>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="startup-scales"></div>
        </div>
    </div>

    <div id="app-viewport" class="flex flex-col hidden">
        <div class="flex flex-1 overflow-hidden">
            <!-- Left Sidebar -->
            <aside class="w-64 bg-black border-r border-neutral-800 flex flex-col p-6 z-30 transition-all duration-500">
                <div class="flex items-center gap-3 mb-10">
                    <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-900/20">
                        <svg width="24" height="24" fill="white" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                    </div>
                    <span class="font-black text-lg tracking-tighter">ULTRA</span>
                </div>

                <nav class="flex-1 space-y-1">
                    <button onclick="setView('home')" class="w-full flex items-center gap-4 px-4 py-3 rounded-xl text-neutral-400 hover:bg-neutral-900 hover:text-white transition">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg> Home
                    </button>
                    <button onclick="setView('library')" class="w-full flex items-center gap-4 px-4 py-3 rounded-xl text-neutral-400 hover:bg-neutral-900 hover:text-white transition">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><path d="M17 21v-8H7v8"/></svg> My Library
                    </button>
                    <div class="pt-6 pb-2 px-4 text-[10px] font-bold text-neutral-600 uppercase tracking-widest">Admin</div>
                    <button onclick="openAdminGate()" class="w-full flex items-center gap-4 px-4 py-3 rounded-xl text-neutral-400 hover:bg-neutral-900 hover:text-white transition relative">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> Dashboard
                        <div id="admin-notif" class="notification-dot"></div>
                    </button>
                    <button onclick="openSettings()" class="w-full flex items-center gap-4 px-4 py-3 rounded-xl text-neutral-400 hover:bg-neutral-900 hover:text-white transition">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg> Settings
                    </button>
                </nav>

                <div id="viz-container" class="mt-auto pt-6 border-t border-neutral-800 hidden">
                    <p class="text-[10px] text-neutral-500 font-bold mb-3 uppercase tracking-widest">Equalizer</p>
                    <div id="visualizer" class="h-12 flex items-end gap-[1px]"></div>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="flex-1 flex flex-col relative bg-neutral-950">
                <header class="p-6 flex items-center justify-between sticky top-0 z-20 glass border-b-0 transition-all duration-500">
                    <div class="relative w-full max-w-lg">
                        <input id="searchInput" type="text" placeholder="Search Jewish tracks..." class="w-full bg-neutral-900 border border-neutral-800 rounded-full py-3 px-12 text-sm focus:ring-2 focus:ring-blue-500 transition outline-none">
                        <svg class="absolute left-4 top-1/2 -translate-y-1/2 text-neutral-500" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <div id="sleep-status" class="hidden flex items-center gap-2 bg-blue-600/20 text-blue-500 px-3 py-1.5 rounded-full text-[10px] font-bold border border-blue-500/30">
                            <svg width="12" height="12" fill="currentColor"><path d="M12 7c0 3.86-3.14 7-7 7-1.1 0-2.14-.26-3.07-.71C3.18 13.79 4.5 12.55 4.5 11c0-1.93-1.57-3.5-3.5-3.5-.54 0-1.04.13-1.5.35C.13 6.91 0 5.97 0 5c0-3.86 3.14-7 7-7 3.86 0 7 3.14 7 7-2 0-3.5 1.5-3.5 3.5S12 12 12 12z"/></svg>
                            <span id="sleep-timer-display">--:--</span>
                        </div>
                        <div class="flex items-center gap-2 bg-neutral-900 p-1 rounded-xl border border-neutral-800">
                            <button onclick="setLayout('grid')" id="lt-grid" class="p-2 rounded-lg bg-neutral-800 text-white transition"><svg width="18" height="18" fill="currentColor"><path d="M3 3h7v7H3zm11 0h7v7h-7zM3 14h7v7H3zm11 0h7v7h-7z"/></svg></button>
                            <button onclick="setLayout('list')" id="lt-list" class="p-2 rounded-lg text-neutral-500 hover:text-white transition"><svg width="18" height="18" fill="currentColor"><path d="M3 4h18v2H3zm0 7h18v2H3zm0 7h18v2H3z"/></svg></button>
                        </div>
                    </div>
                </header>

                <div id="scrollContent" class="flex-1 overflow-y-auto p-8 custom-scrollbar">
                    <div id="resultsGrid" class="grid gap-6"></div>
                </div>

                <!-- Toast Notification -->
                <div id="toast" class="fixed bottom-32 left-1/2 -translate-x-1/2 bg-blue-600 text-white px-6 py-3 rounded-full font-bold text-sm shadow-2xl transition-all opacity-0 translate-y-4 pointer-events-none z-[150]">
                    Action Completed
                </div>
            </main>
        </div>

        <!-- Footer Player -->
        <footer class="h-28 bg-black border-t border-neutral-800 px-8 flex items-center justify-between z-50 transition-all">
            <div class="flex items-center gap-4 w-1/4">
                <img id="p-art" src="https://via.placeholder.com/150" class="w-16 h-16 rounded-xl object-cover shadow-2xl border border-neutral-800">
                <div class="min-w-0">
                    <h4 id="p-title" class="font-bold text-sm truncate">Ready to stream</h4>
                    <p id="p-artist" class="text-xs text-neutral-500 truncate">Select a song</p>
                </div>
            </div>

            <div class="flex flex-col items-center gap-3 flex-1 max-w-2xl px-10">
                <div class="flex items-center gap-8">
                    <button onclick="prevSong()" class="text-neutral-500 hover:text-white transition"><svg width="24" height="24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6L18 6v12z"/></svg></button>
                    <button onclick="togglePlay()" class="w-12 h-12 bg-white text-black rounded-full flex items-center justify-center hover:scale-110 active:scale-95 transition">
                        <svg width="24" height="24" fill="currentColor" id="p-icon"><path d="M8 5v14l11-7z"/></svg>
                    </button>
                    <button onclick="nextSong()" class="text-neutral-500 hover:text-white transition"><svg width="24" height="24" fill="currentColor"><path d="M6 18l8.5-6L6 6zM16 6h2v12h-2z"/></svg></button>
                </div>
                <div class="w-full flex items-center gap-4">
                    <span id="currTime" class="text-[10px] font-mono text-neutral-500 w-10 text-right">0:00</span>
                    <input id="seekBar" type="range" value="0" step="0.1" class="flex-1 h-1 bg-neutral-800 rounded-full appearance-none">
                    <span id="totalTime" class="text-[10px] font-mono text-neutral-500 w-10">0:00</span>
                </div>
            </div>

            <div class="flex items-center justify-end gap-6 w-1/4">
                <div class="flex items-center gap-3">
                    <svg width="18" height="18" fill="currentColor" class="text-neutral-500"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
                    <input id="volBar" type="range" min="0" max="1" step="0.01" value="0.8" class="w-24 h-1 bg-neutral-800 rounded-full appearance-none">
                </div>
                <button onclick="toggleTheater()" id="theater-btn" class="text-neutral-500 hover:text-white transition" title="Toggle Theater Mode">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M2 12h20"/></svg>
                </button>
            </div>
        </footer>

        <!-- MODALS -->

        <!-- Details Modal -->
        <div id="detailsModal" class="fixed inset-0 z-[100] bg-black/95 hidden animate-pop">
            <div class="h-full flex flex-col p-10 overflow-y-auto custom-scrollbar">
                <div class="max-w-5xl mx-auto w-full">
                    <div class="flex justify-between items-center mb-10">
                        <span class="text-xs font-bold text-neutral-500 tracking-widest uppercase">Streaming & Platform Links</span>
                        <button onclick="closeModal('detailsModal')" class="w-12 h-12 bg-neutral-900 border border-neutral-800 rounded-full flex items-center justify-center hover:bg-neutral-800 transition">
                            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6 6 18M6 6l12 12"/></svg>
                        </button>
                    </div>
                    <div id="detailsContent"></div>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-md hidden flex items-center justify-center">
            <div class="bg-neutral-950 border border-neutral-800 w-full max-w-xl rounded-3xl p-10 max-h-[90vh] overflow-y-auto custom-scrollbar">
                <h2 class="text-3xl font-black mb-8">Settings</h2>
                <div class="space-y-8">
                    <section>
                        <h4 class="text-xs font-bold text-neutral-500 uppercase tracking-widest mb-4">Application Scale</h4>
                        <div id="settings-scales" class="grid grid-cols-4 gap-2"></div>
                    </section>
                    
                    <section class="p-6 bg-neutral-900 rounded-2xl border border-neutral-800">
                        <h4 class="text-xs font-bold text-neutral-500 uppercase tracking-widest mb-4">Sleep Timer</h4>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="setSleepTimer(15)" class="p-3 bg-black border border-neutral-800 rounded-xl hover:bg-blue-600 transition text-xs font-bold">15 Min</button>
                            <button onclick="setSleepTimer(30)" class="p-3 bg-black border border-neutral-800 rounded-xl hover:bg-blue-600 transition text-xs font-bold">30 Min</button>
                            <button onclick="setSleepTimer(60)" class="p-3 bg-black border border-neutral-800 rounded-xl hover:bg-blue-600 transition text-xs font-bold">1 Hour</button>
                            <button onclick="setSleepTimer(0)" class="p-3 bg-red-600/20 text-red-500 border border-red-500/30 rounded-xl hover:bg-red-600 hover:text-white transition text-xs font-bold col-span-3">Cancel Timer</button>
                        </div>
                    </section>

                    <section class="flex items-center justify-between p-4 bg-neutral-900 rounded-2xl border border-neutral-800">
                        <div>
                            <h4 class="font-bold">Audio Equalizer</h4>
                            <p class="text-xs text-neutral-500">Enable real-time wave visualization</p>
                        </div>
                        <input type="checkbox" id="vizToggle" onchange="toggleVizFeature(this.checked)" class="w-6 h-6 rounded border-neutral-700 bg-neutral-800 text-blue-600 focus:ring-blue-600">
                    </section>
                </div>
                <button onclick="closeModal('settingsModal')" class="w-full mt-10 bg-white text-black py-4 rounded-2xl font-black hover:scale-[1.02] transition">Close</button>
            </div>
        </div>

        <!-- Admin Gate -->
        <div id="adminGate" class="fixed inset-0 z-[110] bg-black/90 hidden items-center justify-center">
            <div class="bg-neutral-900 border border-neutral-800 p-10 rounded-3xl w-full max-w-md text-center">
                <h2 class="text-2xl font-bold mb-6">Master Access</h2>
                <div id="pinView">
                    <input id="pinInput" type="password" placeholder="â€¢â€¢â€¢â€¢" class="w-full bg-black border border-neutral-800 rounded-2xl py-4 text-center text-3xl tracking-widest mb-4 outline-none focus:border-blue-500 transition">
                    <button onclick="verifyPin()" class="w-full bg-blue-600 py-4 rounded-2xl font-bold mb-4 transition active:scale-95">Unlock</button>
                    <button onclick="showRecovery()" class="text-sm text-neutral-500 hover:text-white">Forgot Security Code?</button>
                </div>
                <div id="recoveryView" class="hidden text-left">
                    <p id="recQ" class="text-sm font-bold mb-2">Question</p>
                    <input id="recA" type="text" class="w-full bg-black border border-neutral-800 p-4 rounded-2xl mb-4 text-sm outline-none">
                    <button onclick="verifyRecovery()" class="w-full bg-green-600 py-4 rounded-2xl font-bold">Recover Access</button>
                </div>
                <button onclick="closeModal('adminGate')" class="mt-6 text-neutral-500 hover:text-white text-sm">Cancel</button>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminPanel" class="fixed inset-0 z-[120] bg-black hidden overflow-y-auto custom-scrollbar">
            <div class="max-w-6xl mx-auto p-12">
                <div class="flex justify-between items-center mb-16">
                    <h1 class="text-4xl font-black">Control Center</h1>
                    <button onclick="closeModal('adminPanel')" class="bg-neutral-900 p-4 rounded-full border border-neutral-800 transition hover:bg-neutral-800"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6 6 18M6 6l12 12"/></svg></button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
                    <!-- Filtering Engine -->
                    <section class="space-y-6">
                        <div class="bg-neutral-900 p-8 rounded-3xl border border-neutral-800">
                            <h3 class="text-xl font-bold mb-6">Filtering Engine</h3>
                            <p class="text-[10px] text-neutral-500 mb-4 uppercase font-bold tracking-widest">Active Rule: Whitelist + Blacklist Combined</p>
                            <div class="space-y-3">
                                <label class="flex items-center justify-between p-4 bg-black rounded-xl border border-neutral-800 cursor-pointer">
                                    <span>None (Unfiltered)</span>
                                    <input type="radio" name="fm" value="none" onchange="updMode(this.value)">
                                </label>
                                <label class="flex items-center justify-between p-4 bg-black rounded-xl border border-neutral-800 cursor-pointer">
                                    <span>Dual (Whitelist + Blacklist)</span>
                                    <input type="radio" name="fm" value="dual" onchange="updMode(this.value)">
                                </label>
                            </div>
                            
                            <div class="mt-8">
                                <h4 class="text-xs font-bold text-neutral-500 mb-3 uppercase tracking-widest">Manage Lists</h4>
                                <div class="flex gap-1 mb-2">
                                    <button onclick="setListType('white')" id="btn-list-white" class="flex-1 py-2 bg-blue-600 rounded-lg text-[10px] font-black">WHITELIST</button>
                                    <button onclick="setListType('black')" id="btn-list-black" class="flex-1 py-2 bg-neutral-800 rounded-lg text-[10px] font-black">BLACKLIST</button>
                                </div>
                                <div class="flex gap-2">
                                    <input id="artIn" type="text" placeholder="Artist/Word" class="flex-1 bg-black border border-neutral-800 p-3 rounded-xl text-sm">
                                    <button onclick="addArt()" class="bg-blue-600 px-4 rounded-xl font-bold text-sm">Add</button>
                                </div>
                                <div id="artList" class="mt-4 space-y-2 h-48 overflow-y-auto pr-2 custom-scrollbar"></div>
                            </div>
                        </div>
                    </section>

                    <!-- Reports System -->
                    <section class="lg:col-span-2 space-y-6">
                        <div class="bg-neutral-900 p-8 rounded-3xl border border-neutral-800">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold">User Reports</h3>
                                <span id="report-count" class="bg-red-500 text-white text-[10px] px-2 py-1 rounded-full font-black">0 PENDING</span>
                            </div>
                            <div id="reportList" class="space-y-4 max-h-[600px] overflow-y-auto pr-2 custom-scrollbar">
                                <p class="text-neutral-500 text-sm italic">No active reports found.</p>
                            </div>
                        </div>
                    </section>
                </div>

                <div class="mt-12 grid grid-cols-1 md:grid-cols-2 gap-12">
                    <section class="bg-neutral-900 p-8 rounded-3xl border border-neutral-800">
                        <h3 class="text-xl font-bold mb-6">Environment Settings</h3>
                        <label class="flex items-center justify-between p-4 bg-black rounded-xl border border-neutral-800 mb-4 cursor-pointer">
                            <span>Enable Global External Links</span>
                            <input type="checkbox" id="linksToggle" onchange="updLinks(this.checked)">
                        </label>
                        <div class="space-y-4 pt-6 border-t border-neutral-800">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-[10px] font-bold text-neutral-500 uppercase">Master PIN</label>
                                    <input id="nPin" type="password" placeholder="Change PIN" class="w-full bg-black border border-neutral-800 p-3 rounded-xl text-sm mt-1">
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-neutral-500 uppercase">Question</label>
                                    <input id="nQuest" type="text" placeholder="Recovery Q" class="w-full bg-black border border-neutral-800 p-3 rounded-xl text-sm mt-1">
                                </div>
                                <div class="col-span-2">
                                    <label class="text-[10px] font-bold text-neutral-500 uppercase">Secret Answer</label>
                                    <input id="nAns" type="password" placeholder="Secret Answer" class="w-full bg-black border border-neutral-800 p-3 rounded-xl text-sm mt-1">
                                </div>
                            </div>
                            <button onclick="saveSec()" class="w-full bg-white text-black py-4 rounded-xl font-black transition hover:scale-[1.01]">Update Security Credentials</button>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- System State ---
        let currentSongs = [];
        let library = JSON.parse(localStorage.getItem('ks_lib') || '[]');
        let reports = JSON.parse(localStorage.getItem('ks_reports') || '[]');
        let currentIndex = -1;
        let isPlaying = false;
        let view = 'home';
        let layout = 'grid';
        let activeAdminList = 'white';
        let sleepTimerId = null;
        let sleepSecondsLeft = 0;
        let audioCtx, analyser, dataArray, source;
        const audio = new Audio();
        audio.crossOrigin = "anonymous";

        const SCALES = [
            { name: 'Tiny', val: 0.5 }, { name: 'Compact', val: 0.65 }, { name: 'Small', val: 0.8 },
            { name: 'Normal', val: 1.0 }, { name: 'Large', val: 1.2 }, { name: 'Wide', val: 1.4 },
            { name: 'Ultra', val: 1.7 }, { name: 'TV/Cinema', val: 2.2 }
        ];

        let admin = JSON.parse(localStorage.getItem('ks_adm') || JSON.stringify({
            pin: '1234',
            q: 'Admin Color?',
            a: 'blue',
            mode: 'dual',
            white: ['Abie Rotenberg', 'Mordechai Shapiro', 'MBD', 'Joey Newcomb', 'Ishay Ribo', 'Shmuel', 'Yitzchak Meir Helfgot'],
            black: [],
            links: true,
            viz: true
        }));

        // --- Initialization ---
        window.onload = () => {
            const hasStarted = localStorage.getItem('ks_started');
            renderScaleButtons('startup-scales');
            renderScaleButtons('settings-scales');
            checkNotifs();
            
            if (!hasStarted) {
                document.getElementById('onboarding').style.display = 'flex';
            } else {
                setAppScale(parseFloat(localStorage.getItem('ks_scale') || '1'));
            }
        };

        function renderScaleButtons(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = SCALES.map(s => `
                <button onclick="setAppScale(${s.val})" class="p-3 border border-neutral-800 rounded-xl hover:bg-blue-600 transition text-xs font-bold">${s.name}</button>
            `).join('');
        }

        function setAppScale(scale) {
            document.documentElement.style.setProperty('--app-scale', scale);
            localStorage.setItem('ks_scale', scale);
            localStorage.setItem('ks_started', 'true');
            document.getElementById('onboarding').style.display = 'none';
            document.getElementById('app-viewport').classList.remove('hidden');
            initApp();
        }

        function initApp() {
            renderMusic('Jewish Music');
            setupSearch();
            setupAudio();
            if(admin.viz) initVisualizer();
        }

        // --- Core UI Logic ---

        function setupSearch() {
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') renderMusic(e.target.value);
            });
        }

        async function renderMusic(q) {
            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = '<div class="col-span-full py-20 text-center text-neutral-500 animate-pulse font-bold">SCANNING ARCHIVES...</div>';
            
            try {
                const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(q)}&entity=song&limit=100`);
                const data = await res.json();
                
                currentSongs = data.results.filter(t => {
                    const art = t.artistName.toLowerCase();
                    const track = t.trackName.toLowerCase();
                    
                    if (admin.mode === 'none') return true;
                    if (admin.mode === 'dual') {
                        // Must be in Whitelist AND NOT in Blacklist
                        const isWhitelisted = admin.white.some(w => art.includes(w.toLowerCase()));
                        const isBlacklisted = admin.black.some(b => art.includes(b.toLowerCase()) || track.includes(b.toLowerCase()));
                        return isWhitelisted && !isBlacklisted;
                    }
                    return true;
                });

                displaySongs();
            } catch (err) {
                grid.innerHTML = '<p class="col-span-full text-center text-red-500">Service unreachable.</p>';
            }
        }

        function displaySongs() {
            const grid = document.getElementById('resultsGrid');
            grid.className = layout === 'grid' 
                ? "grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6" 
                : "flex flex-col gap-2";

            grid.innerHTML = currentSongs.map((s, idx) => {
                const isLib = library.some(x => x.trackId === s.trackId);
                const artwork = s.artworkUrl100.replace('100x100','600x600');
                
                if (layout === 'grid') {
                    return `
                        <div onclick="playSong(${idx})" class="song-card bg-neutral-900 p-4 rounded-3xl border border-neutral-800 cursor-pointer animate-pop relative">
                            <div class="aspect-square mb-4 rounded-2xl overflow-hidden relative group">
                                <img src="${artwork}" class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition flex items-center justify-center">
                                    <div class="p-4 bg-white text-black rounded-full shadow-xl"><svg width="20" height="20" fill="currentColor"><path d="M8 5v14l11-7z"/></svg></div>
                                </div>
                            </div>
                            <h3 class="font-bold text-sm truncate">${s.trackName}</h3>
                            <p class="text-xs text-neutral-500 truncate mb-4">${s.artistName}</p>
                            <div class="flex justify-between items-center">
                                <div class="flex gap-2">
                                    <button onclick="event.stopPropagation(); toggleLib(${idx})" class="${isLib ? 'text-red-500' : 'text-neutral-700'} hover:scale-110 transition"><svg width="18" height="18" fill="${isLib ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2.5"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg></button>
                                    <button onclick="event.stopPropagation(); reportSong(${idx})" class="text-neutral-700 hover:text-red-400 transition" title="Report Song"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1v12zM4 22v-7"/></svg></button>
                                </div>
                                <button onclick="event.stopPropagation(); showDetails(${idx})" class="text-[10px] font-black text-neutral-600 uppercase tracking-tighter hover:text-white transition">Links & Info</button>
                            </div>
                        </div>`;
                } else {
                    return `
                        <div onclick="playSong(${idx})" class="flex items-center gap-4 p-3 bg-neutral-900/40 rounded-2xl border border-neutral-800 hover:bg-neutral-800 transition cursor-pointer">
                            <img src="${s.artworkUrl100}" class="w-12 h-12 rounded-lg">
                            <div class="flex-1 min-w-0"><h4 class="text-sm font-bold truncate">${s.trackName}</h4><p class="text-xs text-neutral-500 truncate">${s.artistName}</p></div>
                            <div class="flex gap-4">
                                <button onclick="event.stopPropagation(); reportSong(${idx})" class="text-neutral-600 hover:text-red-400" title="Report"><svg width="18" height="18" fill="none" stroke="currentColor"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1v12zM4 22v-7"/></svg></button>
                                <button onclick="event.stopPropagation(); toggleLib(${idx})" class="${isLib ? 'text-red-500' : 'text-neutral-700'}"><svg width="18" height="18" fill="${isLib ? 'currentColor' : 'none'}" stroke="currentColor"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg></button>
                                <button onclick="event.stopPropagation(); showDetails(${idx})" class="p-2 text-neutral-500 hover:text-white"><svg width="20" height="20" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg></button>
                            </div>
                        </div>`;
                }
            }).join('');
        }

        // --- Audio Context & Visualization ---

        function setupAudio() {
            const seek = document.getElementById('seekBar');
            const vol = document.getElementById('volBar');
            
            audio.ontimeupdate = () => {
                const p = (audio.currentTime / audio.duration) * 100;
                seek.value = p || 0;
                document.getElementById('currTime').innerText = fmt(audio.currentTime);
                document.getElementById('totalTime').innerText = fmt(audio.duration);
            };

            seek.oninput = () => audio.currentTime = (seek.value / 100) * audio.duration;
            vol.oninput = () => audio.volume = vol.value;
            audio.onended = () => nextSong();
        }

        function initVisualizer() {
            const viz = document.getElementById('visualizer');
            const cont = document.getElementById('viz-container');
            cont.classList.remove('hidden');
            viz.innerHTML = '';
            for(let i=0; i<32; i++) {
                const b = document.createElement('div');
                b.className = 'visualizer-bar';
                viz.appendChild(b);
            }

            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioCtx.createAnalyser();
                source = audioCtx.createMediaElementSource(audio);
                source.connect(analyser);
                analyser.connect(audioCtx.destination);
                analyser.fftSize = 64;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
            }

            function frame() {
                requestAnimationFrame(frame);
                if (!isPlaying) return;
                analyser.getByteFrequencyData(dataArray);
                const bars = document.querySelectorAll('.visualizer-bar');
                bars.forEach((b, i) => {
                    const h = (dataArray[i] / 255) * 44;
                    b.style.height = `${Math.max(4, h)}px`;
                });
            }
            frame();
        }

        function playSong(i) {
            if (i === currentIndex) return togglePlay();
            currentIndex = i;
            const s = currentSongs[i];
            audio.src = s.previewUrl;
            audio.play();
            isPlaying = true;
            if (audioCtx?.state === 'suspended') audioCtx.resume();
            updPlayer();
        }

        function togglePlay() {
            if (!audio.src) return;
            isPlaying ? audio.pause() : audio.play();
            isPlaying = !isPlaying;
            updPlayer();
        }

        function updPlayer() {
            const s = currentSongs[currentIndex];
            if (!s) return;
            document.getElementById('p-art').src = s.artworkUrl100;
            document.getElementById('p-title').innerText = s.trackName;
            document.getElementById('p-artist').innerText = s.artistName;
            document.getElementById('p-icon').innerHTML = isPlaying ? '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>' : '<path d="M8 5v14l11-7z"/>';
        }

        // --- Sleep Timer ---
        function setSleepTimer(mins) {
            if (sleepTimerId) clearInterval(sleepTimerId);
            const status = document.getElementById('sleep-status');
            const display = document.getElementById('sleep-timer-display');

            if (mins === 0) {
                status.classList.add('hidden');
                showToast("Sleep Timer Cancelled");
                return;
            }

            sleepSecondsLeft = mins * 60;
            status.classList.remove('hidden');
            showToast(`Sleep Timer set for ${mins} minutes`);

            sleepTimerId = setInterval(() => {
                sleepSecondsLeft--;
                const m = Math.floor(sleepSecondsLeft / 60);
                const s = sleepSecondsLeft % 60;
                display.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;

                if (sleepSecondsLeft <= 0) {
                    clearInterval(sleepTimerId);
                    if (isPlaying) togglePlay();
                    status.classList.add('hidden');
                    showToast("Sleep Timer Finished - Music Stopped");
                }
            }, 1000);
        }

        // --- Details & Modals ---

        function showDetails(i) {
            const s = currentSongs[i];
            const modal = document.getElementById('detailsModal');
            const target = document.getElementById('detailsContent');
            modal.classList.remove('hidden');
            
            const q = encodeURIComponent(`${s.artistName} ${s.trackName}`);
            const links = admin.links ? `
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mt-10">
                    <a href="https://youtube.com/results?search_query=${q}" target="_blank" class="p-4 bg-neutral-900 rounded-2xl border border-neutral-800 hover:border-red-500 transition flex items-center justify-between">YouTube <svg width="14" height="14" fill="currentColor"><path d="M10 15V6l7 4.5z"/></svg></a>
                    <a href="https://music.apple.com/search?term=${q}" target="_blank" class="p-4 bg-neutral-900 rounded-2xl border border-neutral-800 hover:border-pink-500 transition flex items-center justify-between">Apple Music</a>
                    <a href="https://music.youtube.com/search?q=${q}" target="_blank" class="p-4 bg-neutral-900 rounded-2xl border border-neutral-800 hover:border-red-600 transition flex items-center justify-between">YouTube Music</a>
                    <a href="https://www.amazon.com/s?k=${q}&i=digital-music" target="_blank" class="p-4 bg-neutral-900 rounded-2xl border border-neutral-800 hover:border-orange-400 transition flex items-center justify-between">Amazon Music</a>
                    <a href="https://open.spotify.com/search/${q}" target="_blank" class="p-4 bg-neutral-900 rounded-2xl border border-neutral-800 hover:border-green-500 transition flex items-center justify-between">Spotify</a>
                    <a href="https://soundcloud.com/search?q=${q}" target="_blank" class="p-4 bg-neutral-900 rounded-2xl border border-neutral-800 hover:border-orange-600 transition flex items-center justify-between">SoundCloud</a>
                    <a href="https://mostlymusic.com/search?q=${q}" target="_blank" class="p-4 bg-neutral-900 rounded-2xl border border-neutral-800 hover:border-blue-500 transition flex items-center justify-between">Mostly Music</a>
                    <a href="https://www.google.com/search?q=${q}+lyrics" target="_blank" class="p-4 bg-blue-600 rounded-2xl font-bold flex items-center justify-center gap-2 transition hover:scale-[1.02]">Google Lyrics Search</a>
                </div>` : '<p class="mt-8 text-neutral-500 italic">External links disabled by Admin.</p>';

            target.innerHTML = `
                <div class="flex flex-col md:flex-row gap-12">
                    <img src="${s.artworkUrl100.replace('100x100','800x800')}" class="w-full md:w-96 rounded-3xl shadow-2xl">
                    <div class="flex-1">
                        <h2 class="text-6xl font-black mb-2 leading-tight">${s.trackName}</h2>
                        <p class="text-2xl text-blue-500 mb-8">${s.artistName}</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 bg-neutral-900 rounded-2xl">
                                <label class="text-[10px] uppercase text-neutral-500 font-black">Album</label>
                                <p class="truncate font-bold">${s.collectionName}</p>
                            </div>
                            <div class="p-4 bg-neutral-900 rounded-2xl">
                                <label class="text-[10px] uppercase text-neutral-500 font-black">Genre</label>
                                <p class="font-bold">${s.primaryGenreName}</p>
                            </div>
                        </div>
                        ${links}
                    </div>
                </div>`;
        }

        // --- Admin & Security ---

        function openAdminGate() {
            document.getElementById('adminGate').classList.remove('hidden');
            document.getElementById('adminGate').classList.add('flex');
            document.getElementById('pinView').classList.remove('hidden');
            document.getElementById('recoveryView').classList.add('hidden');
        }

        function verifyPin() {
            const p = document.getElementById('pinInput').value;
            if (p === admin.pin) {
                closeModal('adminGate');
                document.getElementById('adminPanel').classList.remove('hidden');
                document.getElementById('pinInput').value = '';
                renderAdmin();
            } else alert("Access Denied.");
        }

        function showRecovery() {
            document.getElementById('pinView').classList.add('hidden');
            document.getElementById('recoveryView').classList.remove('hidden');
            document.getElementById('recQ').innerText = admin.q;
        }

        function verifyRecovery() {
            const a = document.getElementById('recA').value;
            if (a.toLowerCase() === admin.a.toLowerCase()) {
                alert(`Security Code Found: ${admin.pin}`);
                closeModal('adminGate');
            } else alert("Recovery Failed.");
        }

        function setListType(type) {
            activeAdminList = type;
            document.getElementById('btn-list-white').className = type === 'white' ? 'flex-1 py-2 bg-blue-600 rounded-lg text-[10px] font-black' : 'flex-1 py-2 bg-neutral-800 rounded-lg text-[10px] font-black';
            document.getElementById('btn-list-black').className = type === 'black' ? 'flex-1 py-2 bg-red-600 rounded-lg text-[10px] font-black' : 'flex-1 py-2 bg-neutral-800 rounded-lg text-[10px] font-black';
            renderAdmin();
        }

        function renderAdmin() {
            const list = document.getElementById('artList');
            const data = activeAdminList === 'white' ? admin.white : admin.black;
            
            list.innerHTML = (admin.mode === 'none' && activeAdminList === 'white') 
                ? '<p class="text-xs text-neutral-600 italic">Filter is disabled. Whitelist ignored.</p>'
                : data.map(n => `
                    <div class="flex items-center justify-between p-3 bg-black rounded-xl border border-neutral-800">
                        <span class="text-sm font-bold">${n}</span>
                        <button onclick="remArt('${n}')" class="text-red-500 font-black px-2 text-lg hover:scale-125 transition">Ã—</button>
                    </div>`).join('');

            document.getElementById('linksToggle').checked = admin.links;
            document.getElementById('nQuest').value = admin.q;
            document.querySelectorAll(`input[name="fm"]`).forEach(r => {
                if(r.value === admin.mode) r.checked = true;
            });

            renderReports();
        }

        function renderReports() {
            const list = document.getElementById('reportList');
            const count = document.getElementById('report-count');
            count.innerText = `${reports.length} PENDING`;
            
            if (reports.length === 0) {
                list.innerHTML = '<p class="text-neutral-500 text-sm italic">No active reports found.</p>';
                return;
            }

            list.innerHTML = reports.map((r, idx) => `
                <div class="bg-black p-6 rounded-2xl border border-neutral-800 flex items-start justify-between gap-6 animate-pop">
                    <div class="flex gap-4">
                        <img src="${r.art}" class="w-16 h-16 rounded-xl">
                        <div>
                            <h4 class="font-bold text-white">${r.track}</h4>
                            <p class="text-xs text-blue-500 mb-2">${r.artist}</p>
                            <p class="text-[10px] text-neutral-500">Reported on ${r.date}</p>
                        </div>
                    </div>
                    <div class="flex flex-col gap-2">
                        <button onclick="adminAction('block_track', ${idx})" class="text-[10px] bg-red-600/20 text-red-500 border border-red-500/30 px-3 py-2 rounded-lg font-bold hover:bg-red-600 hover:text-white transition">BLOCK TRACK</button>
                        <button onclick="adminAction('block_artist', ${idx})" class="text-[10px] bg-orange-600/20 text-orange-500 border border-orange-500/30 px-3 py-2 rounded-lg font-bold hover:bg-orange-600 hover:text-white transition">BLOCK ARTIST</button>
                        <button onclick="adminAction('dismiss', ${idx})" class="text-[10px] bg-neutral-800 text-neutral-400 px-3 py-2 rounded-lg font-bold hover:bg-neutral-700 hover:text-white transition">DISMISS</button>
                    </div>
                </div>
            `).join('');
        }

        function adminAction(type, idx) {
            const r = reports[idx];
            if (type === 'block_track') {
                admin.black.push(r.track);
            } else if (type === 'block_artist') {
                admin.black.push(r.artist);
            }
            reports.splice(idx, 1);
            localStorage.setItem('ks_reports', JSON.stringify(reports));
            save();
            renderAdmin();
            checkNotifs();
            renderMusic('Jewish Music');
        }

        function reportSong(idx) {
            const s = currentSongs[idx];
            const exists = reports.some(r => r.id === s.trackId);
            if (exists) return showToast("Already Reported");

            reports.push({
                id: s.trackId,
                track: s.trackName,
                artist: s.artistName,
                art: s.artworkUrl100,
                date: new Date().toLocaleDateString()
            });

            localStorage.setItem('ks_reports', JSON.stringify(reports));
            checkNotifs();
            showToast("Report Submitted to Admin");
        }

        function checkNotifs() {
            const dot = document.getElementById('admin-notif');
            dot.style.display = reports.length > 0 ? 'block' : 'none';
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = '1';
            t.style.transform = 'translate(-50%, -20px)';
            setTimeout(() => {
                t.style.opacity = '0';
                t.style.transform = 'translate(-50%, 16px)';
            }, 3000);
        }

        function addArt() {
            const val = document.getElementById('artIn').value;
            if (!val) return;
            if (activeAdminList === 'white') admin.white.push(val);
            else admin.black.push(val);
            save(); renderAdmin();
            document.getElementById('artIn').value = '';
            renderMusic('Jewish Music');
        }

        function remArt(n) {
            if (activeAdminList === 'white') admin.white = admin.white.filter(x => x !== n);
            else admin.black = admin.black.filter(x => x !== n);
            save(); renderAdmin();
            renderMusic('Jewish Music');
        }

        function updMode(m) { 
            admin.mode = m; 
            save(); 
            renderAdmin(); 
            renderMusic('Jewish Music'); 
        }
        
        function updLinks(l) { admin.links = l; save(); }

        function saveSec() {
            const p = document.getElementById('nPin').value;
            const q = document.getElementById('nQuest').value;
            const a = document.getElementById('nAns').value;
            
            let updated = false;
            if (p) { admin.pin = p; updated = true; }
            if (q) { admin.q = q; updated = true; }
            if (a) { admin.a = a; updated = true; }
            
            if (updated) {
                save();
                showToast("Security Credentials Updated");
                document.getElementById('nPin').value = '';
                document.getElementById('nAns').value = '';
            }
        }

        // --- Theater Mode ---
        let theaterActive = false;
        function toggleTheater() {
            theaterActive = !theaterActive;
            document.body.classList.toggle('theater-mode');
            const btn = document.getElementById('theater-btn');
            btn.classList.toggle('text-blue-500');
            btn.classList.toggle('text-neutral-500');
            
            if(theaterActive) {
                showToast("Theater Mode Active");
            }
        }

        // --- Helper Logic ---

        function toggleVizFeature(on) {
            admin.viz = on;
            save();
            const cont = document.getElementById('viz-container');
            on ? initVisualizer() : cont.classList.add('hidden');
        }

        function toggleLib(i) {
            const s = currentSongs[i];
            const idx = library.findIndex(x => x.trackId === s.trackId);
            idx > -1 ? library.splice(idx, 1) : library.push(s);
            localStorage.setItem('ks_lib', JSON.stringify(library));
            displaySongs();
        }

        function setView(v) {
            view = v;
            if (v === 'library') { currentSongs = library; displaySongs(); }
            else renderMusic('Jewish Music');
        }

        function setLayout(l) {
            layout = l;
            document.getElementById('lt-grid').className = l === 'grid' ? 'p-2 rounded-lg bg-neutral-800 text-white' : 'p-2 rounded-lg text-neutral-500';
            document.getElementById('lt-list').className = l === 'list' ? 'p-2 rounded-lg bg-neutral-800 text-white' : 'p-2 rounded-lg text-neutral-500';
            displaySongs();
        }

        function closeModal(id) { 
            document.getElementById(id).classList.add('hidden');
            if(id === 'adminGate') document.getElementById(id).classList.remove('flex');
        }

        function openSettings() { 
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('vizToggle').checked = admin.viz;
        }

        function nextSong() { if (currentIndex < currentSongs.length - 1) playSong(currentIndex + 1); }
        function prevSong() { if (currentIndex > 0) playSong(currentIndex - 1); }
        function fmt(s) { if(!s) return "0:00"; const m = Math.floor(s/60); const sc = Math.floor(s%60); return `${m}:${sc<10?'0':''}${sc}`; }
        function save() { localStorage.setItem('ks_adm', JSON.stringify(admin)); }
    </script>
</body>
</html>
